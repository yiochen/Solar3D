<!DOCTYPE html>
<html>

<head>
    <title>Testing threejs</title>
    <!--    <script type="text/javascript" scr="three.js"></script>-->
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        
        canvas {
            width: 100%;
            height: 100%
        }
    </style>
</head>

<body>
    <script type="text/javascript" src="libs/three.js"></script>
    <script type="text/javascript" src="libs/dat.gui.min.js"></script>
    <script type="text/javascript" src="libs/stats.min.js"></script>
    <script type="text/javascript" src="libs/OrbitControls.js"></script>
    <script type="text/javascript">
        var scene;
        var camera;
        var stats;
        var renderer;
        var controls;
        var sun;
        var CONST = {
            maxRadius: 10,
            primaryColor: 0x98cbff,
            primaryColor2: 0xcbff98,
            accentColor: 0xff98cb,
            boxSize: 10000,
        };
        var stars = [];
        window.onload = init;

        function init() {
            scene = new THREE.Scene();
            //view_angle, ratio(width/height), near, far
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 20000);
            scene.add(camera);
            camera.position.set(0, 0, 300);
            camera.lookAt(scene.position);
            renderer = new THREE.WebGLRenderer({
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 1.0);
            renderer.shadowMapEnabled = true;
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            createObjects();

            //create_geometry();
            create_stats();
            document.body.appendChild(renderer.domElement);
            render();
        }

        function create_stats() {
            stats = new Stats();
            stats.setMode(0);
            stats.domElement.style.position = "absolute";
            stats.domElement.style.left = "0";
            stats.domElement.style.top = "0";
            document.body.appendChild(stats.domElement);
            console.log("created stats");

        }

        function createObjects() {
            createSky();
            createFloor();
            createSun();
            createStar(4, 50, 3, 0.01);
            createStar(6, 70, 4, 0.012);
            createLight();
        }

        function createLight() {
            var ambLight = new THREE.AmbientLight(0x262626);
            scene.add(ambLight);
            var pointLight = new THREE.PointLight(CONST.accentColor, 2, 1000);
            scene.add(pointLight);
            var dirLight = new THREE.DirectionalLight(CONST.primaryColor, 0.5);
            dirLight.position.set(0, 1, 0);
            scene.add(dirLight);

            var dirLight2 = new THREE.DirectionalLight(CONST.primaryColor2, 0.5);
            dirLight2.position.set(0, -1, 0);
            scene.add(dirLight2);
        }

        function createSky() {
            var skyboxGeo = new THREE.BoxGeometry(CONST.boxSize, CONST.boxSize, CONST.boxSize);
            var skyboxMat = new THREE.MeshBasicMaterial({
                color: CONST.primaryColor,
                side: THREE.BackSide,
            });
            var skyboxMesh = new THREE.Mesh(skyboxGeo, skyboxMat);

            scene.add(skyboxMesh);
        }

        function createFloor() {
            var floorGeo = new THREE.PlaneGeometry(CONST.boxSize, CONST.boxSize);
            var floorMat = new THREE.MeshPhongMaterial({
                color: 0xFFFFFF,
                side: THREE.DoubleSide
            });

            var floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = 0.5 * Math.PI;
            floor.position.y = -CONST.maxRadius - 3;
            floor.receiveShadow = true;
            scene.add(floor);

        }

        function addGlow() {

        }

        function createSun() {
            sun = createStar(10, 0);
            sun.material = new THREE.MeshBasicMaterial({
                map: new THREE.ImageUtils.loadTexture('assets/sunmap.jpg')
            });

            //sun.prop.stall = true;

            var spriteMaterial = new THREE.SpriteMaterial({
                map: new THREE.ImageUtils.loadTexture('assets/glow.png'),
                useScreenCoordinates: false,
                color: 0xFFCD00,
                transparent: false,
                blending: THREE.AdditiveBlending,
            });
            var sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(sun.prop.radius * 4, sun.prop.radius * 4, 1.0);
            sun.add(sprite);

        }

        function createStar(radius, distance, angle, angularVel) {
            var starGeo = new THREE.SphereGeometry(radius, 30, 30);
            var starMat = new THREE.MeshPhongMaterial({
                color: 0xFFFFFF,
                emissive: 0x000033,
            });
            var starMesh = new THREE.Mesh(starGeo, starMat);

            var prop = {
                radius: radius,
                distance: distance,
                angle: (typeof (angle) !== 'undefined') ? angle : 0,
                angularVel: (typeof (angularVel) !== 'undefined') ? angularVel : 0,
                stall: false,
            };

            starMesh.prop = prop;
            moveToAngle(starMesh);
            stars.push(starMesh);
            scene.add(starMesh);
            return starMesh;
        }






        function moveToAngle(star) {
            var prop = star.prop;
            if (!prop) {
                return;
            }
            var x = prop.distance * Math.sin(prop.angle);
            var z = prop.distance * Math.cos(prop.angle);
            star.position.set(x, 0, z);
        }

        function updateStar(star) {
            star.prop.angle += star.prop.angularVel;
            moveToAngle(star);
            star.rotation.y += 0.1;
        }

        function render() {
            stats.update();
            controls.update();
            for (var star of stars)
                if (!star.prop.stall) updateStar(star);
            requestAnimationFrame(render);
            renderer.render(scene, camera);
        }
    </script>
</body>

</html>